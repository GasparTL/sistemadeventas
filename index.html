<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escaner Local PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; }
        button.secondary { background: #6c757d; margin-top: 10px; }
        #preview { width: 100%; height: 200px; object-fit: contain; background: #eee; border: 1px dashed #999; margin-top: 10px; }
        
        /* Estilos para la lista de archivos */
        .file-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .file-info { font-size: 0.9em; }
        .btn-download { background: #28a745; width: auto; padding: 5px 15px; font-size: 0.8em; }
    </style>
</head>
<body>

    <h1>üìÑ Esc√°ner Local</h1>

    <div class="card">
        <h3>1. Nuevo Documento</h3>
        
        <label>Nombre del archivo:</label>
        <input type="text" id="fileName" placeholder="Ej: Factura Luz">

        <label>Guardar en Carpeta:</label>
        <div style="display: flex; gap: 5px;">
            <select id="folderSelect">
                <option value="General">General</option>
                <option value="Trabajo">Trabajo</option>
                <option value="Personal">Personal</option>
            </select>
            <button style="width: 40px;" onclick="nuevaCarpeta()">+</button>
        </div>

        <label>Foto del documento:</label>
        <input type="file" id="imageInput" accept="image/*" capture="environment">
        
        <img id="preview">

        <button onclick="guardarDocumento()">üíæ Guardar en App</button>
    </div>

    <div class="card">
        <h3>üìÇ Mis Documentos</h3>
        <label>Filtrar por carpeta:</label>
        <select id="filterFolder" onchange="mostrarArchivos()">
            <option value="Todas">Todas</option>
        </select>

        <div id="fileList">
            </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN Y VARIABLES ---
        const { jsPDF } = window.jspdf;
        let dbCarpetas = ["General", "Trabajo", "Personal"];
        let dbArchivos = []; // Aqu√≠ simulamos la base de datos en memoria
        let imagenActualBase64 = null;

        // Al cargar la p√°gina, intentamos recuperar datos guardados anteriormente (LocalStorage)
        window.onload = function() {
            if(localStorage.getItem('misCarpetas')) {
                dbCarpetas = JSON.parse(localStorage.getItem('misCarpetas'));
                actualizarSelectores();
            }
            if(localStorage.getItem('misArchivos')) {
                dbArchivos = JSON.parse(localStorage.getItem('misArchivos'));
                mostrarArchivos();
            }
        };

        // --- 2. L√ìGICA DE CAPTURA DE IMAGEN ---
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    imagenActualBase64 = event.target.result;
                    document.getElementById('preview').src = imagenActualBase64;
                }
                reader.readAsDataURL(file);
            }
        });

        // --- 3. L√ìGICA DE CARPETAS ---
        function nuevaCarpeta() {
            const nombre = prompt("Nombre de la nueva carpeta:");
            if (nombre && !dbCarpetas.includes(nombre)) {
                dbCarpetas.push(nombre);
                localStorage.setItem('misCarpetas', JSON.stringify(dbCarpetas));
                actualizarSelectores();
            }
        }

        function actualizarSelectores() {
            const select = document.getElementById('folderSelect');
            const filter = document.getElementById('filterFolder');
            
            // Limpiar
            select.innerHTML = "";
            filter.innerHTML = "<option value='Todas'>Todas</option>";

            dbCarpetas.forEach(c => {
                let opt1 = document.createElement("option");
                opt1.value = c; opt1.text = c;
                select.appendChild(opt1);

                let opt2 = document.createElement("option");
                opt2.value = c; opt2.text = c;
                filter.appendChild(opt2);
            });
        }

        // --- 4. GUARDAR (DENTRO DEL PROGRAMA) ---
        function guardarDocumento() {
            if (!imagenActualBase64) return alert("¬°Toma una foto primero!");
            
            const nombre = document.getElementById('fileName').value || "Sin Titulo";
            const carpeta = document.getElementById('folderSelect').value;

            // Creamos el objeto documento
            const nuevoDoc = {
                id: Date.now(), // ID √∫nico basado en la fecha
                nombre: nombre,
                carpeta: carpeta,
                fecha: new Date().toLocaleDateString(),
                imagen: imagenActualBase64 // Guardamos la imagen codificada
            };

            dbArchivos.push(nuevoDoc);
            
            // Guardamos en la memoria del navegador
            // NOTA: LocalStorage tiene l√≠mite de espacio (5-10MB). 
            // Para una app real profesional usar√≠amos IndexedDB.
            try {
                localStorage.setItem('misArchivos', JSON.stringify(dbArchivos));
                mostrarArchivos();
                alert("Guardado en la carpeta: " + carpeta);
                
                // Limpiar formulario
                document.getElementById('fileName').value = "";
                document.getElementById('preview').src = "";
                imagenActualBase64 = null;
            } catch (e) {
                alert("Memoria llena. Borra algunos archivos antiguos.");
            }
        }

        // --- 5. MOSTRAR Y DESCARGAR ---
        function mostrarArchivos() {
            const lista = document.getElementById('fileList');
            const filtro = document.getElementById('filterFolder').value;
            lista.innerHTML = "";

            const archivosFiltrados = dbArchivos.filter(doc => 
                filtro === "Todas" ? true : doc.carpeta === filtro
            );

            if(archivosFiltrados.length === 0) {
                lista.innerHTML = "<p style='color:#777; text-align:center'>No hay archivos aqu√≠</p>";
                return;
            }

            archivosFiltrados.forEach(doc => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-info">
                        <strong>${doc.nombre}</strong><br>
                        <span style="color:#666; font-size:0.8em">üìÖ ${doc.fecha} | üìÅ ${doc.carpeta}</span>
                    </div>
                    <button class="btn-download" onclick="descargarPDF(${doc.id})">‚¨á PDF</button>
                `;
                lista.appendChild(item);
            });
        }

        async function descargarPDF(id) {
            const docData = dbArchivos.find(d => d.id === id);
            if (!docData) return;

            const doc = new jsPDF();
            // Agregamos la imagen al PDF (Ajustada a A4)
            doc.addImage(docData.imagen, 'JPEG', 10, 10, 190, 0);
            
            // Esto fuerza la descarga al almacenamiento del tel√©fono
            doc.save(`${docData.nombre}.pdf`);
        }
    </script>
</body>
</html>
