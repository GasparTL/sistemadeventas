<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escaner Gaspar Sin Anuncios</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; background: #f4f4f9; color: #333; }
        h1, h3 { margin-top: 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Inputs y Botones */
        input, select, button { width: 100%; padding: 12px; margin-top: 8px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        button { background: #007bff; color: white; border: none; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        button:active { transform: scale(0.98); }
        button.delete { background: #dc3545; margin-top: 5px; }
        button.zip { background: #6610f2; margin-bottom: 15px; }
        button.icon-btn { width: auto; padding: 5px 10px; margin: 0; }

        /* Vistas previas */
        #preview { width: 100%; height: 200px; object-fit: contain; background: #eee; border-radius: 8px; margin-top: 10px; display: none; }
        
        /* Lista de Archivos */
        .folder-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .file-item { background: #fafafa; border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .file-info { font-size: 0.9em; overflow: hidden; }
        .file-actions { display: flex; gap: 5px; }
        .tag { background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; color: #555; }
    </style>
</head>
<body>

    <h1>üì± Esc√°ner Gaspar</h1>

    <div class="card">
        <h3>üì∏ Escanear / Subir</h3>
        
        <label>Nombre del Archivo:</label>
        <input type="text" id="fileName" placeholder="Ej: Ticket Compra">

        <label>Guardar en Carpeta:</label>
        <div style="display: flex; gap: 5px;">
            <select id="folderSelect"></select>
            <button class="icon-btn" onclick="crearCarpeta()" title="Crear Carpeta">‚ûï</button>
        </div>

        <input type="file" id="imageInput" accept="image/*" capture="environment">
        <img id="preview">

        <button onclick="guardarDocumento()" id="btnGuardar" style="margin-top:15px; display:none;">üíæ Guardar PDF</button>
    </div>

    <div class="card">
        <div class="folder-header">
            <h3>üìÇ Archivos</h3>
            <button class="icon-btn delete" onclick="eliminarCarpetaActual()" title="Eliminar carpeta actual">üóëÔ∏è Carpeta</button>
        </div>

        <label>Ver Carpeta:</label>
        <select id="filterFolder" onchange="cargarArchivosUI()"></select>

        <br><br>
        <button class="zip" id="btnZip" onclick="descargarCarpetaZip()" style="display:none;">üì¶ Descargar Carpeta (.ZIP)</button>

        <div id="fileList">Cargando...</div>
    </div>

    <script>
        // --- 1. BASE DE DATOS POTENTE (IndexedDB) ---
        // Esto permite guardar muchos megabytes de fotos sin l√≠mite.
        const DB_NAME = "EscanerDB_v2";
        let db;

        const request = indexedDB.open(DB_NAME, 1);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            // Almac√©n de Carpetas
            if (!db.objectStoreNames.contains("folders")) {
                const folderStore = db.createObjectStore("folders", { keyPath: "name" });
                folderStore.add({ name: "General" }); // Carpeta por defecto
            }
            // Almac√©n de Archivos
            if (!db.objectStoreNames.contains("files")) {
                const fileStore = db.createObjectStore("files", { keyPath: "id", autoIncrement: true });
                fileStore.createIndex("folder", "folder", { unique: false });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            cargarCarpetasUI();
            cargarArchivosUI();
        };

        // --- 2. L√ìGICA DE INTERFAZ Y CAPTURA ---
        
        let imagenBase64 = null;

        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    imagenBase64 = evt.target.result;
                    const img = document.getElementById('preview');
                    img.src = imagenBase64;
                    img.style.display = "block";
                    document.getElementById('btnGuardar').style.display = "block";
                };
                reader.readAsDataURL(file);
            }
        });

        // --- 3. GESTI√ìN DE CARPETAS ---

        function crearCarpeta() {
            const nombre = prompt("Nombre de la nueva carpeta:");
            if (!nombre) return;

            const tx = db.transaction(["folders"], "readwrite");
            const store = tx.objectStore("folders");
            
            const req = store.add({ name: nombre });
            
            req.onsuccess = () => {
                alert("Carpeta creada");
                cargarCarpetasUI();
            };
            req.onerror = () => alert("Esa carpeta ya existe.");
        }

        function cargarCarpetasUI() {
            const tx = db.transaction(["folders"], "readonly");
            const store = tx.objectStore("folders");
            const request = store.getAll();

            request.onsuccess = () => {
                const carpetas = request.result;
                const selectGuardar = document.getElementById('folderSelect');
                const selectFiltrar = document.getElementById('filterFolder');
                
                // Guardar selecci√≥n actual para no perderla al refrescar
                const valGuardar = selectGuardar.value;
                const valFiltrar = selectFiltrar.value;

                selectGuardar.innerHTML = "";
                selectFiltrar.innerHTML = "<option value='TODO'>-- Ver Todo --</option>";

                carpetas.forEach(c => {
                    selectGuardar.innerHTML += `<option value="${c.name}">${c.name}</option>`;
                    selectFiltrar.innerHTML += `<option value="${c.name}">${c.name}</option>`;
                });

                if(valGuardar) selectGuardar.value = valGuardar;
                if(valFiltrar) selectFiltrar.value = valFiltrar;
            };
        }

        function eliminarCarpetaActual() {
            const carpeta = document.getElementById('filterFolder').value;
            if (carpeta === "TODO" || carpeta === "General") {
                return alert("No puedes eliminar 'Ver Todo' ni la carpeta 'General'.");
            }

            if (!confirm(`¬øEst√°s seguro de eliminar la carpeta "${carpeta}" y TODOS sus archivos?`)) return;

            // 1. Eliminar archivos
            const tx = db.transaction(["files", "folders"], "readwrite");
            const fileStore = tx.objectStore("files");
            const folderIndex = fileStore.index("folder");
            const folderStore = tx.objectStore("folders");

            // Buscar todos los archivos de esa carpeta
            const request = folderIndex.getAllKeys(IDBKeyRange.only(carpeta));

            request.onsuccess = () => {
                const ids = request.result;
                // Borrar cada archivo
                ids.forEach(id => fileStore.delete(id));
                
                // Borrar la carpeta
                folderStore.delete(carpeta);

                tx.oncomplete = () => {
                    alert("Carpeta eliminada.");
                    document.getElementById('filterFolder').value = "TODO";
                    cargarCarpetasUI();
                    cargarArchivosUI();
                };
            };
        }

        // --- 4. GUARDAR Y LISTAR ARCHIVOS ---

        function guardarDocumento() {
            const nombre = document.getElementById('fileName').value || "Doc Sin Titulo";
            const carpeta = document.getElementById('folderSelect').value;

            const doc = {
                name: nombre,
                folder: carpeta,
                date: new Date().toLocaleDateString(),
                image: imagenBase64
            };

            const tx = db.transaction(["files"], "readwrite");
            tx.objectStore("files").add(doc);

            tx.oncomplete = () => {
                alert("Guardado exitosamente.");
                // Limpiar
                document.getElementById('fileName').value = "";
                document.getElementById('preview').style.display = "none";
                document.getElementById('imageInput').value = ""; 
                document.getElementById('btnGuardar').style.display = "none";
                imagenBase64 = null;
                cargarArchivosUI();
            };
        }

        function cargarArchivosUI() {
            const filtro = document.getElementById('filterFolder').value;
            const btnZip = document.getElementById('btnZip');
            const lista = document.getElementById('fileList');
            lista.innerHTML = "";

            // Solo mostrar bot√≥n ZIP si se selecciona una carpeta espec√≠fica
            btnZip.style.display = (filtro !== "TODO") ? "block" : "none";

            const tx = db.transaction(["files"], "readonly");
            const store = tx.objectStore("files");
            let request;

            if (filtro === "TODO") {
                request = store.getAll();
            } else {
                const index = store.index("folder");
                request = index.getAll(IDBKeyRange.only(filtro));
            }

            request.onsuccess = () => {
                const archivos = request.result;
                if (archivos.length === 0) {
                    lista.innerHTML = "<p style='text-align:center; color:#888'>Carpeta vac√≠a</p>";
                    return;
                }

                archivos.forEach(doc => {
                    const div = document.createElement("div");
                    div.className = "file-item";
                    div.innerHTML = `
                        <div class="file-info">
                            <strong>${doc.name}</strong><br>
                            <span class="tag">${doc.folder}</span> <span style="font-size:0.8em; color:#888">${doc.date}</span>
                        </div>
                        <div class="file-actions">
                            <button class="icon-btn" style="background:#28a745" onclick="descargarPDF(${doc.id})">‚¨á</button>
                            <button class="icon-btn delete" onclick="borrarArchivo(${doc.id})">‚úñ</button>
                        </div>
                    `;
                    lista.appendChild(div);
                });
            };
        }

        function borrarArchivo(id) {
            if(!confirm("¬øBorrar este archivo?")) return;
            const tx = db.transaction(["files"], "readwrite");
            tx.objectStore("files").delete(id);
            tx.oncomplete = () => cargarArchivosUI();
        }

        // --- 5. DESCARGAS (PDF INDIVIDUAL Y ZIP) ---

        async function descargarPDF(id) {
            // Buscamos el archivo en la BD
            const tx = db.transaction(["files"], "readonly");
            const req = tx.objectStore("files").get(id);
            
            req.onsuccess = async () => {
                const doc = req.result;
                if(!doc) return;
                
                const pdf = new window.jspdf.jsPDF();
                pdf.addImage(doc.image, 'JPEG', 10, 10, 190, 0); // Ajuste autom√°tico de altura
                pdf.save(`${doc.name}.pdf`);
            };
        }

        async function descargarCarpetaZip() {
            const carpetaNombre = document.getElementById('filterFolder').value;
            if(carpetaNombre === "TODO") return;

            const tx = db.transaction(["files"], "readonly");
            const index = tx.objectStore("files").index("folder");
            const req = index.getAll(IDBKeyRange.only(carpetaNombre));

            req.onsuccess = async () => {
                const archivos = req.result;
                if(archivos.length === 0) return alert("La carpeta est√° vac√≠a.");

                const zip = new JSZip();
                const folderZip = zip.folder(carpetaNombre);
                
                alert(`Generando ZIP con ${archivos.length} documentos... espera un momento.`);

                // Generamos un PDF por cada archivo encontrado
                for (let doc of archivos) {
                    const pdf = new window.jspdf.jsPDF();
                    pdf.addImage(doc.image, 'JPEG', 10, 10, 190, 0);
                    // Convertimos el PDF a Blob
                    const pdfBlob = pdf.output('blob');
                    // Lo metemos en el ZIP
                    folderZip.file(`${doc.name}.pdf`, pdfBlob);
                }

                // Generar el archivo .zip final y descargarlo
                const content = await zip.generateAsync({type:"blob"});
                
                // Truco para descargar blob
                const link = document.createElement("a");
                link.href = URL.createObjectURL(content);
                link.download = `${carpetaNombre}.zip`;
                link.click();
            };
        }

    </script>
</body>
</html>
